name: FTP Deploy (Laravel App Layer)

on:
  push:
    branches:
      - main
    paths:
      - app/**
      - config/**
      - routes/**
      - resources/**
      - bootstrap/app.php
  workflow_dispatch:
    inputs:
      from:
        description: SHA الأساس للمقارنة
        required: false
        default: ""

permissions:
  contents: read

concurrency:
  group: ftp-deploy-app-layer-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate secrets
        shell: bash
        run: |
          required=(FTP_SERVER FTP_USERNAME FTP_PASSWORD REMOTE_PUBLIC)
          missing=0
          for s in "${required[@]}"; do
            if [ -z "${!s}" ]; then
              echo "Missing secret: $s"
              missing=1
            fi
          done
          if [ "$missing" -eq 1 ]; then
            exit 1
          fi
        env:
          FTP_SERVER: ${{ secrets.FTP_SERVER }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
          REMOTE_PUBLIC: ${{ secrets.REMOTE_PUBLIC }}

      - name: Determine diff range
        id: diff
        shell: bash
        run: |
          FROM="${{ github.event.inputs.from }}"
          if [ -z "$FROM" ]; then
            FROM="${{ github.event.before }}"
          fi
          if [ -z "$FROM" ]; then
            FROM="$(git rev-parse HEAD~1)"
          fi
          echo "from=$FROM" >> "$GITHUB_OUTPUT"

      - name: Collect changed files in app layer
        shell: bash
        run: |
          set -e
          git diff --name-only --diff-filter=AM "${{ steps.diff.outputs.from }}" "${{ github.sha }}" > all_changed.txt
          grep -E '^(app/|config/|routes/|resources/|bootstrap/app\.php)' all_changed.txt | sed '/^\s*$/d' > changed.txt || true
          if [ -s changed.txt ]; then
            echo "Files to upload:"
            cat changed.txt
          else
            echo "No changes in app layer"
          fi

      - name: Stop if nothing to upload
        shell: bash
        run: |
          if [ ! -s changed.txt ]; then
            exit 0
          fi

      - name: Install lftp
        shell: bash
        run: |
          sudo apt-get update -y
          sudo apt-get install -y lftp

      - name: Upload changed files via FTP
        env:
          FTP_SERVER: ${{ secrets.FTP_SERVER }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
          REMOTE_PUBLIC: ${{ secrets.REMOTE_PUBLIC }}
        shell: bash
        run: |
          set -e
          echo "set ftp:passive-mode true" > lftp.cmd
          echo "set net:max-retries 2" >> lftp.cmd
          echo "set net:timeout 20" >> lftp.cmd
          echo "cd \"$REMOTE_PUBLIC\"" >> lftp.cmd
          while IFS= read -r f; do
            d="$(dirname "$f")"
            if [ "$d" = "." ]; then d=""; fi
            if [ -n "$d" ]; then
              echo "mkdir -p -f \"$d\"" >> lftp.cmd
              echo "put -O \"$d\" \"$f\"" >> lftp.cmd
            else
              echo "put \"$f\"" >> lftp.cmd
            fi
          done < changed.txt
          echo "bye" >> lftp.cmd
          lftp -u "$FTP_USERNAME","$FTP_PASSWORD" "$FTP_SERVER" -f lftp.cmd

      - name: Verify uploaded files exist remotely
        env:
          FTP_SERVER: ${{ secrets.FTP_SERVER }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
          REMOTE_PUBLIC: ${{ secrets.REMOTE_PUBLIC }}
        shell: bash
        run: |
          set -e
          echo "cd \"$REMOTE_PUBLIC\"" > verify.cmd
          while IFS= read -r f; do
            d="$(dirname "$f")"
            b="$(basename "$f")"
            if [ "$d" = "." ]; then d=""; fi
            if [ -n "$d" ]; then
              echo "cls -l \"$d\" | grep \" $b$\" || echo \"Missing: $f\"" >> verify.cmd
            else
              echo "cls -l | grep \" $b$\" || echo \"Missing: $f\"" >> verify.cmd
            fi
          done < changed.txt
          echo "bye" >> verify.cmd
          lftp -u "$FTP_USERNAME","$FTP_PASSWORD" "$FTP_SERVER" -f verify.cmd
