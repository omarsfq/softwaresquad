name: FTP Deploy (Vendor Changes)

on:
  push:
    branches:
      - main
    paths:
      - composer.lock
  workflow_dispatch:
    inputs:
      from:
        description: SHA الأساس للمقارنة
        required: false
        default: ""

permissions:
  contents: read

concurrency:
  group: ftp-deploy-vendor-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate secrets
        shell: bash
        run: |
          required=(FTP_SERVER FTP_USERNAME FTP_PASSWORD REMOTE_PUBLIC)
          missing=0
          for s in "${required[@]}"; do
            if [ -z "${!s}" ]; then
              echo "Missing secret: $s"
              missing=1
            fi
          done
          if [ "$missing" -eq 1 ]; then
            exit 1
          fi
        env:
          FTP_SERVER: ${{ secrets.FTP_SERVER }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
          REMOTE_PUBLIC: ${{ secrets.REMOTE_PUBLIC }}

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          tools: composer
          coverage: none

      - name: Cache Composer
        uses: actions/cache@v4
        with:
          path: ~/.composer/cache
          key: composer-${{ runner.os }}-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            composer-${{ runner.os }}-

      - name: Install vendor with Composer
        shell: bash
        run: |
          composer install --no-dev --prefer-dist --no-interaction --no-progress

      - name: Collect vendor files to upload
        shell: bash
        run: |
          set -e
          find vendor -type f > changed.txt || true
          if [ -s changed.txt ]; then
            echo "Files to upload:"
            cat changed.txt
          else
            echo "No vendor files found"
          fi

      - name: Stop if nothing to upload
        shell: bash
        run: |
          if [ ! -s changed.txt ]; then
            exit 0
          fi

      - name: Install lftp
        shell: bash
        run: |
          sudo apt-get update -y
          sudo apt-get install -y lftp

      - name: Upload vendor changed files via FTP
        env:
          FTP_SERVER: ${{ secrets.FTP_SERVER }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
          REMOTE_PUBLIC: ${{ secrets.REMOTE_PUBLIC }}
        shell: bash
        run: |
          set -e
          echo "set ftp:passive-mode true" > lftp.cmd
          echo "set net:max-retries 2" >> lftp.cmd
          echo "set net:timeout 20" >> lftp.cmd
          echo "open -u \"$FTP_USERNAME\",\"$FTP_PASSWORD\" \"$FTP_SERVER\"" >> lftp.cmd
          echo "cd \"$REMOTE_PUBLIC\"" >> lftp.cmd
          while IFS= read -r f; do
            d="$(dirname "$f")"
            if [ "$d" = "." ]; then d=""; fi
            if [ -n "$d" ]; then
              echo "mkdir -p -f \"$d\"" >> lftp.cmd
              echo "put -O \"$d\" \"$f\"" >> lftp.cmd
            else
              echo "put \"$f\"" >> lftp.cmd
            fi
          done < changed.txt
          echo "bye" >> lftp.cmd
          lftp -f lftp.cmd

      - name: Verify uploaded vendor files exist remotely
        env:
          FTP_SERVER: ${{ secrets.FTP_SERVER }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
          REMOTE_PUBLIC: ${{ secrets.REMOTE_PUBLIC }}
        shell: bash
        run: |
          set -e
          echo "open -u \"$FTP_USERNAME\",\"$FTP_PASSWORD\" \"$FTP_SERVER\"" > verify.cmd
          echo "cd \"$REMOTE_PUBLIC\"" >> verify.cmd
          while IFS= read -r f; do
            d="$(dirname "$f")"
            b="$(basename "$f")"
            if [ "$d" = "." ]; then d=""; fi
            if [ -n "$d" ]; then
              echo "cls -l \"$d\" | grep \" $b$\" || echo \"Missing: $f\"" >> verify.cmd
            else
              echo "cls -l | grep \" $b$\" || echo \"Missing: $f\"" >> verify.cmd
            fi
          done < changed.txt
          echo "bye" >> verify.cmd
          lftp -f verify.cmd
